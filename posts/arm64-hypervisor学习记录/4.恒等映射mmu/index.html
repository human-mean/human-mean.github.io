<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>4.æ’ç­‰æ˜ å°„MMU | åµŒå…¥å¼å­¦ä¹ ç¬”è®°</title><meta name=keywords content><meta name=description content="
ğŸ“‹ ä¸€äº›åŸºç¡€æ¦‚å¿µ


Stage 1:å°†è™šæ‹Ÿåœ°å€ (VA) è½¬æ¢ä¸ºç‰©ç†åœ°å€ (PA)ï¼ˆåœ¨éè™šæ‹ŸåŒ–ç¯å¢ƒä¸‹ï¼‰æˆ–è€…è½¬æ¢ä¸ºä¸­é—´ç‰©ç†åœ°å€ (IPA)ï¼ˆåœ¨è™šæ‹ŸåŒ–ç¯å¢ƒä¸‹ï¼‰ã€‚å®ƒä¸»è¦å— OS æ§åˆ¶ï¼Œç”¨æ¥åšè¿›ç¨‹éš”ç¦»ã€‚


Stage 2ï¼šå°† IPA è½¬æ¢ä¸ºçœŸæ­£çš„ ç‰©ç†åœ°å€ (PA)ã€‚



ä¸ºä»€ä¹ˆéœ€è¦MMUï¼Ÿ
è£¸æœºä»£ç ä¸­CPUå‘é€çš„åœ°å€ç›´æ¥å‘é€åˆ°ç‰©ç†å†…å­˜ã€‚ä½†å­˜åœ¨å‡ ä¸ªé—®é¢˜ï¼š

æ‰€æœ‰ä»£ç éƒ½èƒ½è®¿é—®æ‰€æœ‰åœ°å€ï¼Œæ²¡æœ‰ä¿æŠ¤
è‹¥è·‘å¤šä¸ªGuest OS,åœ°å€ä¼šå­˜åœ¨å†²çª
æ²¡æ³•æ§åˆ¶æŸæ®µå†…å­˜æ˜¯ cacheable è¿˜æ˜¯ device ç±»å‹

MMUå°±æ˜¯åœ¨CPUå’Œç‰©ç†å†…å­˜ä¸­å……å½“äº†ç¿»è¯‘ï¼šCPUå‘é€è™šæ‹Ÿåœ°å€ï¼ˆVAï¼‰ï¼ŒMMUé€šè¿‡æŸ¥è¡¨ç¿»è¯‘æˆç‰©ç†åœ°å€ï¼ˆPAï¼‰ï¼ŒåŒæ—¶é™„å¸¦æƒé™å’Œå±æ€§çš„ä¿¡æ¯ã€‚MMUæŸ¥çš„è¿™ä¸ªè¡¨å°±æ˜¯é¡µè¡¨ã€‚
æ’ç­‰æ˜ å°„ï¼š

æ’ç­‰æ˜ å°„å³è™šæ‹Ÿåœ°å€=ç‰©ç†åœ°å€

å…ˆä»æ’ç­‰æ˜ å°„å¼€å§‹æ˜¯å› ä¸ºï¼š

ä» BootLoader/BIOS è·³è½¬åˆ°æ“ä½œç³»ç»Ÿ(å¦‚ Linux å†…æ ¸)å…¥å£æ—¶,MMU æ˜¯å…³é—­çš„ã€‚å…³é—­äº†MMU æ„å‘³ç€ä¸èƒ½åˆ©ç”¨é«˜é€Ÿç¼“å­˜çš„æ€§èƒ½ã€‚
MMU å…³é—­: æ‰€æœ‰å†…å­˜è®¿é—®éƒ½æ˜¯ Non-cacheable,æ¯æ¬¡è®¿é—®ä¸»å­˜ ~100+ cyclesã€‚
MMU å¼€å¯: é¡µè¡¨æ ‡è®°å†…å­˜ä¸º Cacheable,Cache å‘½ä¸­ ~3-5 cyclesã€‚
å› æ­¤,æˆ‘ä»¬åœ¨åˆå§‹åŒ–çš„æŸä¸ªé˜¶æ®µéœ€è¦æŠŠ MMU æ‰“å¼€å¹¶ä¸”ä½¿èƒ½æ•°æ®é«˜é€Ÿç¼“å­˜,ä»¥è·å¾—æ›´é«˜çš„æ€§èƒ½ã€‚

ä½†æ˜¯MMUå¼€å¯çš„ç¬é—´ï¼ŒCPUå‘é€çš„æ‰€æœ‰æŒ‡ä»¤éƒ½ä¼šè¢«ç¿»è¯‘ã€‚å¦‚æœVAâ‰ PAï¼ŒPCæŒ‡å‘çš„åœ°å€ä¼šæŒ‡å‘é”™è¯¯ä½ç½®ã€‚è¿™æ—¶å€™æ’ç­‰æ˜ å°„å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œç¡®ä¿å¼€å¯å‰åä»£ç èƒ½æ­£å¸¸è¿è¡Œ
é¡µè¡¨
å‡è®¾æœ‰ä¸€ä¸ªuint64_t table[512],é€šè¿‡indexï¼Œæ•°ç»„è¿”å›ä¸€ä¸ªå€¼ã€‚é¡µè¡¨åŸç†ç±»ä¼¼ï¼ŒMMUæ‹¿åˆ°ä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼Œä»é‡Œé¢æ‰¾åˆ°å‡ ä¸ªbitå½“ä½œindexï¼Œä»é¡µè¡¨å»æŸ¥æ•°ç»„ï¼Œå¾—åˆ°ç»“æœã€‚å¦‚æœä¸€çº§æ•°ç»„æ¥è¦†ç›–æ•´ä¸ª48-bitåœ°å€ç©ºé—´ï¼Œéœ€è¦2^48ï¼Œä¸ç°å®ã€‚
æ‰€ä»¥éœ€è¦ç”¨åˆ°å¤šçº§æ•°ç»„ã€‚4KB garanuleæ˜¯ä¸€ä¸ªå››ç»´æ•°ç»„æŸ¥æ‰¾ï¼š

table_L0[i0] -> æŒ‡å‘table_L1
table_L1[i1] -> æŒ‡å‘table_L2
table_L2[i2] -> æŒ‡å‘table_L3
table_L3[i3] -> æœ€ç»ˆçš„ç‰©ç†é¡µåœ°å€







 




    
    
        
        ä¸ºä»€ä¹ˆæ˜¯ 48-bit & 4çº§é¡µè¡¨ï¼Ÿ
    
    
    
        1. åŸºç¡€é™åˆ¶"><meta name=author content><link rel=canonical href=https://human-mean.github.io/posts/arm64-hypervisor%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/4.%E6%81%92%E7%AD%89%E6%98%A0%E5%B0%84mmu/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://human-mean.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://human-mean.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://human-mean.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://human-mean.github.io/apple-touch-icon.png><link rel=mask-icon href=https://human-mean.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://human-mean.github.io/posts/arm64-hypervisor%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/4.%E6%81%92%E7%AD%89%E6%98%A0%E5%B0%84mmu/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="https://human-mean.github.io/posts/arm64-hypervisor%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/4.%E6%81%92%E7%AD%89%E6%98%A0%E5%B0%84mmu/"><meta property="og:site_name" content="åµŒå…¥å¼å­¦ä¹ ç¬”è®°"><meta property="og:title" content="4.æ’ç­‰æ˜ å°„MMU"><meta property="og:description" content=" ğŸ“‹ ä¸€äº›åŸºç¡€æ¦‚å¿µ
Stage 1:å°†è™šæ‹Ÿåœ°å€ (VA) è½¬æ¢ä¸ºç‰©ç†åœ°å€ (PA)ï¼ˆåœ¨éè™šæ‹ŸåŒ–ç¯å¢ƒä¸‹ï¼‰æˆ–è€…è½¬æ¢ä¸ºä¸­é—´ç‰©ç†åœ°å€ (IPA)ï¼ˆåœ¨è™šæ‹ŸåŒ–ç¯å¢ƒä¸‹ï¼‰ã€‚å®ƒä¸»è¦å— OS æ§åˆ¶ï¼Œç”¨æ¥åšè¿›ç¨‹éš”ç¦»ã€‚
Stage 2ï¼šå°† IPA è½¬æ¢ä¸ºçœŸæ­£çš„ ç‰©ç†åœ°å€ (PA)ã€‚
ä¸ºä»€ä¹ˆéœ€è¦MMUï¼Ÿ è£¸æœºä»£ç ä¸­CPUå‘é€çš„åœ°å€ç›´æ¥å‘é€åˆ°ç‰©ç†å†…å­˜ã€‚ä½†å­˜åœ¨å‡ ä¸ªé—®é¢˜ï¼š
æ‰€æœ‰ä»£ç éƒ½èƒ½è®¿é—®æ‰€æœ‰åœ°å€ï¼Œæ²¡æœ‰ä¿æŠ¤ è‹¥è·‘å¤šä¸ªGuest OS,åœ°å€ä¼šå­˜åœ¨å†²çª æ²¡æ³•æ§åˆ¶æŸæ®µå†…å­˜æ˜¯ cacheable è¿˜æ˜¯ device ç±»å‹ MMUå°±æ˜¯åœ¨CPUå’Œç‰©ç†å†…å­˜ä¸­å……å½“äº†ç¿»è¯‘ï¼šCPUå‘é€è™šæ‹Ÿåœ°å€ï¼ˆVAï¼‰ï¼ŒMMUé€šè¿‡æŸ¥è¡¨ç¿»è¯‘æˆç‰©ç†åœ°å€ï¼ˆPAï¼‰ï¼ŒåŒæ—¶é™„å¸¦æƒé™å’Œå±æ€§çš„ä¿¡æ¯ã€‚MMUæŸ¥çš„è¿™ä¸ªè¡¨å°±æ˜¯é¡µè¡¨ã€‚
æ’ç­‰æ˜ å°„ï¼š æ’ç­‰æ˜ å°„å³è™šæ‹Ÿåœ°å€=ç‰©ç†åœ°å€
å…ˆä»æ’ç­‰æ˜ å°„å¼€å§‹æ˜¯å› ä¸ºï¼š
ä» BootLoader/BIOS è·³è½¬åˆ°æ“ä½œç³»ç»Ÿ(å¦‚ Linux å†…æ ¸)å…¥å£æ—¶,MMU æ˜¯å…³é—­çš„ã€‚å…³é—­äº†MMU æ„å‘³ç€ä¸èƒ½åˆ©ç”¨é«˜é€Ÿç¼“å­˜çš„æ€§èƒ½ã€‚ MMU å…³é—­: æ‰€æœ‰å†…å­˜è®¿é—®éƒ½æ˜¯ Non-cacheable,æ¯æ¬¡è®¿é—®ä¸»å­˜ ~100+ cyclesã€‚ MMU å¼€å¯: é¡µè¡¨æ ‡è®°å†…å­˜ä¸º Cacheable,Cache å‘½ä¸­ ~3-5 cyclesã€‚ å› æ­¤,æˆ‘ä»¬åœ¨åˆå§‹åŒ–çš„æŸä¸ªé˜¶æ®µéœ€è¦æŠŠ MMU æ‰“å¼€å¹¶ä¸”ä½¿èƒ½æ•°æ®é«˜é€Ÿç¼“å­˜,ä»¥è·å¾—æ›´é«˜çš„æ€§èƒ½ã€‚
ä½†æ˜¯MMUå¼€å¯çš„ç¬é—´ï¼ŒCPUå‘é€çš„æ‰€æœ‰æŒ‡ä»¤éƒ½ä¼šè¢«ç¿»è¯‘ã€‚å¦‚æœVAâ‰ PAï¼ŒPCæŒ‡å‘çš„åœ°å€ä¼šæŒ‡å‘é”™è¯¯ä½ç½®ã€‚è¿™æ—¶å€™æ’ç­‰æ˜ å°„å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œç¡®ä¿å¼€å¯å‰åä»£ç èƒ½æ­£å¸¸è¿è¡Œ
é¡µè¡¨ å‡è®¾æœ‰ä¸€ä¸ªuint64_t table[512],é€šè¿‡indexï¼Œæ•°ç»„è¿”å›ä¸€ä¸ªå€¼ã€‚é¡µè¡¨åŸç†ç±»ä¼¼ï¼ŒMMUæ‹¿åˆ°ä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼Œä»é‡Œé¢æ‰¾åˆ°å‡ ä¸ªbitå½“ä½œindexï¼Œä»é¡µè¡¨å»æŸ¥æ•°ç»„ï¼Œå¾—åˆ°ç»“æœã€‚å¦‚æœä¸€çº§æ•°ç»„æ¥è¦†ç›–æ•´ä¸ª48-bitåœ°å€ç©ºé—´ï¼Œéœ€è¦2^48ï¼Œä¸ç°å®ã€‚
æ‰€ä»¥éœ€è¦ç”¨åˆ°å¤šçº§æ•°ç»„ã€‚4KB garanuleæ˜¯ä¸€ä¸ªå››ç»´æ•°ç»„æŸ¥æ‰¾ï¼š
table_L0[i0] -> æŒ‡å‘table_L1 table_L1[i1] -> æŒ‡å‘table_L2 table_L2[i2] -> æŒ‡å‘table_L3 table_L3[i3] -> æœ€ç»ˆçš„ç‰©ç†é¡µåœ°å€ ä¸ºä»€ä¹ˆæ˜¯ 48-bit & 4çº§é¡µè¡¨ï¼Ÿ 1. åŸºç¡€é™åˆ¶"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-02-03T00:00:00+00:00"><meta property="article:modified_time" content="2026-02-03T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="4.æ’ç­‰æ˜ å°„MMU"><meta name=twitter:description content="
ğŸ“‹ ä¸€äº›åŸºç¡€æ¦‚å¿µ


Stage 1:å°†è™šæ‹Ÿåœ°å€ (VA) è½¬æ¢ä¸ºç‰©ç†åœ°å€ (PA)ï¼ˆåœ¨éè™šæ‹ŸåŒ–ç¯å¢ƒä¸‹ï¼‰æˆ–è€…è½¬æ¢ä¸ºä¸­é—´ç‰©ç†åœ°å€ (IPA)ï¼ˆåœ¨è™šæ‹ŸåŒ–ç¯å¢ƒä¸‹ï¼‰ã€‚å®ƒä¸»è¦å— OS æ§åˆ¶ï¼Œç”¨æ¥åšè¿›ç¨‹éš”ç¦»ã€‚


Stage 2ï¼šå°† IPA è½¬æ¢ä¸ºçœŸæ­£çš„ ç‰©ç†åœ°å€ (PA)ã€‚



ä¸ºä»€ä¹ˆéœ€è¦MMUï¼Ÿ
è£¸æœºä»£ç ä¸­CPUå‘é€çš„åœ°å€ç›´æ¥å‘é€åˆ°ç‰©ç†å†…å­˜ã€‚ä½†å­˜åœ¨å‡ ä¸ªé—®é¢˜ï¼š

æ‰€æœ‰ä»£ç éƒ½èƒ½è®¿é—®æ‰€æœ‰åœ°å€ï¼Œæ²¡æœ‰ä¿æŠ¤
è‹¥è·‘å¤šä¸ªGuest OS,åœ°å€ä¼šå­˜åœ¨å†²çª
æ²¡æ³•æ§åˆ¶æŸæ®µå†…å­˜æ˜¯ cacheable è¿˜æ˜¯ device ç±»å‹

MMUå°±æ˜¯åœ¨CPUå’Œç‰©ç†å†…å­˜ä¸­å……å½“äº†ç¿»è¯‘ï¼šCPUå‘é€è™šæ‹Ÿåœ°å€ï¼ˆVAï¼‰ï¼ŒMMUé€šè¿‡æŸ¥è¡¨ç¿»è¯‘æˆç‰©ç†åœ°å€ï¼ˆPAï¼‰ï¼ŒåŒæ—¶é™„å¸¦æƒé™å’Œå±æ€§çš„ä¿¡æ¯ã€‚MMUæŸ¥çš„è¿™ä¸ªè¡¨å°±æ˜¯é¡µè¡¨ã€‚
æ’ç­‰æ˜ å°„ï¼š

æ’ç­‰æ˜ å°„å³è™šæ‹Ÿåœ°å€=ç‰©ç†åœ°å€

å…ˆä»æ’ç­‰æ˜ å°„å¼€å§‹æ˜¯å› ä¸ºï¼š

ä» BootLoader/BIOS è·³è½¬åˆ°æ“ä½œç³»ç»Ÿ(å¦‚ Linux å†…æ ¸)å…¥å£æ—¶,MMU æ˜¯å…³é—­çš„ã€‚å…³é—­äº†MMU æ„å‘³ç€ä¸èƒ½åˆ©ç”¨é«˜é€Ÿç¼“å­˜çš„æ€§èƒ½ã€‚
MMU å…³é—­: æ‰€æœ‰å†…å­˜è®¿é—®éƒ½æ˜¯ Non-cacheable,æ¯æ¬¡è®¿é—®ä¸»å­˜ ~100+ cyclesã€‚
MMU å¼€å¯: é¡µè¡¨æ ‡è®°å†…å­˜ä¸º Cacheable,Cache å‘½ä¸­ ~3-5 cyclesã€‚
å› æ­¤,æˆ‘ä»¬åœ¨åˆå§‹åŒ–çš„æŸä¸ªé˜¶æ®µéœ€è¦æŠŠ MMU æ‰“å¼€å¹¶ä¸”ä½¿èƒ½æ•°æ®é«˜é€Ÿç¼“å­˜,ä»¥è·å¾—æ›´é«˜çš„æ€§èƒ½ã€‚

ä½†æ˜¯MMUå¼€å¯çš„ç¬é—´ï¼ŒCPUå‘é€çš„æ‰€æœ‰æŒ‡ä»¤éƒ½ä¼šè¢«ç¿»è¯‘ã€‚å¦‚æœVAâ‰ PAï¼ŒPCæŒ‡å‘çš„åœ°å€ä¼šæŒ‡å‘é”™è¯¯ä½ç½®ã€‚è¿™æ—¶å€™æ’ç­‰æ˜ å°„å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œç¡®ä¿å¼€å¯å‰åä»£ç èƒ½æ­£å¸¸è¿è¡Œ
é¡µè¡¨
å‡è®¾æœ‰ä¸€ä¸ªuint64_t table[512],é€šè¿‡indexï¼Œæ•°ç»„è¿”å›ä¸€ä¸ªå€¼ã€‚é¡µè¡¨åŸç†ç±»ä¼¼ï¼ŒMMUæ‹¿åˆ°ä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼Œä»é‡Œé¢æ‰¾åˆ°å‡ ä¸ªbitå½“ä½œindexï¼Œä»é¡µè¡¨å»æŸ¥æ•°ç»„ï¼Œå¾—åˆ°ç»“æœã€‚å¦‚æœä¸€çº§æ•°ç»„æ¥è¦†ç›–æ•´ä¸ª48-bitåœ°å€ç©ºé—´ï¼Œéœ€è¦2^48ï¼Œä¸ç°å®ã€‚
æ‰€ä»¥éœ€è¦ç”¨åˆ°å¤šçº§æ•°ç»„ã€‚4KB garanuleæ˜¯ä¸€ä¸ªå››ç»´æ•°ç»„æŸ¥æ‰¾ï¼š

table_L0[i0] -> æŒ‡å‘table_L1
table_L1[i1] -> æŒ‡å‘table_L2
table_L2[i2] -> æŒ‡å‘table_L3
table_L3[i3] -> æœ€ç»ˆçš„ç‰©ç†é¡µåœ°å€







 




    
    
        
        ä¸ºä»€ä¹ˆæ˜¯ 48-bit & 4çº§é¡µè¡¨ï¼Ÿ
    
    
    
        1. åŸºç¡€é™åˆ¶"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://human-mean.github.io/posts/"},{"@type":"ListItem","position":2,"name":"4.æ’ç­‰æ˜ å°„MMU","item":"https://human-mean.github.io/posts/arm64-hypervisor%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/4.%E6%81%92%E7%AD%89%E6%98%A0%E5%B0%84mmu/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"4.æ’ç­‰æ˜ å°„MMU","name":"4.æ’ç­‰æ˜ å°„MMU","description":" ğŸ“‹ ä¸€äº›åŸºç¡€æ¦‚å¿µ\nStage 1:å°†è™šæ‹Ÿåœ°å€ (VA) è½¬æ¢ä¸ºç‰©ç†åœ°å€ (PA)ï¼ˆåœ¨éè™šæ‹ŸåŒ–ç¯å¢ƒä¸‹ï¼‰æˆ–è€…è½¬æ¢ä¸ºä¸­é—´ç‰©ç†åœ°å€ (IPA)ï¼ˆåœ¨è™šæ‹ŸåŒ–ç¯å¢ƒä¸‹ï¼‰ã€‚å®ƒä¸»è¦å— OS æ§åˆ¶ï¼Œç”¨æ¥åšè¿›ç¨‹éš”ç¦»ã€‚\nStage 2ï¼šå°† IPA è½¬æ¢ä¸ºçœŸæ­£çš„ ç‰©ç†åœ°å€ (PA)ã€‚\nä¸ºä»€ä¹ˆéœ€è¦MMUï¼Ÿ è£¸æœºä»£ç ä¸­CPUå‘é€çš„åœ°å€ç›´æ¥å‘é€åˆ°ç‰©ç†å†…å­˜ã€‚ä½†å­˜åœ¨å‡ ä¸ªé—®é¢˜ï¼š\næ‰€æœ‰ä»£ç éƒ½èƒ½è®¿é—®æ‰€æœ‰åœ°å€ï¼Œæ²¡æœ‰ä¿æŠ¤ è‹¥è·‘å¤šä¸ªGuest OS,åœ°å€ä¼šå­˜åœ¨å†²çª æ²¡æ³•æ§åˆ¶æŸæ®µå†…å­˜æ˜¯ cacheable è¿˜æ˜¯ device ç±»å‹ MMUå°±æ˜¯åœ¨CPUå’Œç‰©ç†å†…å­˜ä¸­å……å½“äº†ç¿»è¯‘ï¼šCPUå‘é€è™šæ‹Ÿåœ°å€ï¼ˆVAï¼‰ï¼ŒMMUé€šè¿‡æŸ¥è¡¨ç¿»è¯‘æˆç‰©ç†åœ°å€ï¼ˆPAï¼‰ï¼ŒåŒæ—¶é™„å¸¦æƒé™å’Œå±æ€§çš„ä¿¡æ¯ã€‚MMUæŸ¥çš„è¿™ä¸ªè¡¨å°±æ˜¯é¡µè¡¨ã€‚\næ’ç­‰æ˜ å°„ï¼š æ’ç­‰æ˜ å°„å³è™šæ‹Ÿåœ°å€=ç‰©ç†åœ°å€\nå…ˆä»æ’ç­‰æ˜ å°„å¼€å§‹æ˜¯å› ä¸ºï¼š\nä» BootLoader/BIOS è·³è½¬åˆ°æ“ä½œç³»ç»Ÿ(å¦‚ Linux å†…æ ¸)å…¥å£æ—¶,MMU æ˜¯å…³é—­çš„ã€‚å…³é—­äº†MMU æ„å‘³ç€ä¸èƒ½åˆ©ç”¨é«˜é€Ÿç¼“å­˜çš„æ€§èƒ½ã€‚ MMU å…³é—­: æ‰€æœ‰å†…å­˜è®¿é—®éƒ½æ˜¯ Non-cacheable,æ¯æ¬¡è®¿é—®ä¸»å­˜ ~100+ cyclesã€‚ MMU å¼€å¯: é¡µè¡¨æ ‡è®°å†…å­˜ä¸º Cacheable,Cache å‘½ä¸­ ~3-5 cyclesã€‚ å› æ­¤,æˆ‘ä»¬åœ¨åˆå§‹åŒ–çš„æŸä¸ªé˜¶æ®µéœ€è¦æŠŠ MMU æ‰“å¼€å¹¶ä¸”ä½¿èƒ½æ•°æ®é«˜é€Ÿç¼“å­˜,ä»¥è·å¾—æ›´é«˜çš„æ€§èƒ½ã€‚\nä½†æ˜¯MMUå¼€å¯çš„ç¬é—´ï¼ŒCPUå‘é€çš„æ‰€æœ‰æŒ‡ä»¤éƒ½ä¼šè¢«ç¿»è¯‘ã€‚å¦‚æœVAâ‰ PAï¼ŒPCæŒ‡å‘çš„åœ°å€ä¼šæŒ‡å‘é”™è¯¯ä½ç½®ã€‚è¿™æ—¶å€™æ’ç­‰æ˜ å°„å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œç¡®ä¿å¼€å¯å‰åä»£ç èƒ½æ­£å¸¸è¿è¡Œ\né¡µè¡¨ å‡è®¾æœ‰ä¸€ä¸ªuint64_t table[512],é€šè¿‡indexï¼Œæ•°ç»„è¿”å›ä¸€ä¸ªå€¼ã€‚é¡µè¡¨åŸç†ç±»ä¼¼ï¼ŒMMUæ‹¿åˆ°ä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼Œä»é‡Œé¢æ‰¾åˆ°å‡ ä¸ªbitå½“ä½œindexï¼Œä»é¡µè¡¨å»æŸ¥æ•°ç»„ï¼Œå¾—åˆ°ç»“æœã€‚å¦‚æœä¸€çº§æ•°ç»„æ¥è¦†ç›–æ•´ä¸ª48-bitåœ°å€ç©ºé—´ï¼Œéœ€è¦2^48ï¼Œä¸ç°å®ã€‚\næ‰€ä»¥éœ€è¦ç”¨åˆ°å¤šçº§æ•°ç»„ã€‚4KB garanuleæ˜¯ä¸€ä¸ªå››ç»´æ•°ç»„æŸ¥æ‰¾ï¼š\ntable_L0[i0] -\u0026gt; æŒ‡å‘table_L1 table_L1[i1] -\u0026gt; æŒ‡å‘table_L2 table_L2[i2] -\u0026gt; æŒ‡å‘table_L3 table_L3[i3] -\u0026gt; æœ€ç»ˆçš„ç‰©ç†é¡µåœ°å€ ä¸ºä»€ä¹ˆæ˜¯ 48-bit \u0026amp; 4çº§é¡µè¡¨ï¼Ÿ 1. åŸºç¡€é™åˆ¶\n","keywords":[],"articleBody":" ğŸ“‹ ä¸€äº›åŸºç¡€æ¦‚å¿µ\nStage 1:å°†è™šæ‹Ÿåœ°å€ (VA) è½¬æ¢ä¸ºç‰©ç†åœ°å€ (PA)ï¼ˆåœ¨éè™šæ‹ŸåŒ–ç¯å¢ƒä¸‹ï¼‰æˆ–è€…è½¬æ¢ä¸ºä¸­é—´ç‰©ç†åœ°å€ (IPA)ï¼ˆåœ¨è™šæ‹ŸåŒ–ç¯å¢ƒä¸‹ï¼‰ã€‚å®ƒä¸»è¦å— OS æ§åˆ¶ï¼Œç”¨æ¥åšè¿›ç¨‹éš”ç¦»ã€‚\nStage 2ï¼šå°† IPA è½¬æ¢ä¸ºçœŸæ­£çš„ ç‰©ç†åœ°å€ (PA)ã€‚\nä¸ºä»€ä¹ˆéœ€è¦MMUï¼Ÿ è£¸æœºä»£ç ä¸­CPUå‘é€çš„åœ°å€ç›´æ¥å‘é€åˆ°ç‰©ç†å†…å­˜ã€‚ä½†å­˜åœ¨å‡ ä¸ªé—®é¢˜ï¼š\næ‰€æœ‰ä»£ç éƒ½èƒ½è®¿é—®æ‰€æœ‰åœ°å€ï¼Œæ²¡æœ‰ä¿æŠ¤ è‹¥è·‘å¤šä¸ªGuest OS,åœ°å€ä¼šå­˜åœ¨å†²çª æ²¡æ³•æ§åˆ¶æŸæ®µå†…å­˜æ˜¯ cacheable è¿˜æ˜¯ device ç±»å‹ MMUå°±æ˜¯åœ¨CPUå’Œç‰©ç†å†…å­˜ä¸­å……å½“äº†ç¿»è¯‘ï¼šCPUå‘é€è™šæ‹Ÿåœ°å€ï¼ˆVAï¼‰ï¼ŒMMUé€šè¿‡æŸ¥è¡¨ç¿»è¯‘æˆç‰©ç†åœ°å€ï¼ˆPAï¼‰ï¼ŒåŒæ—¶é™„å¸¦æƒé™å’Œå±æ€§çš„ä¿¡æ¯ã€‚MMUæŸ¥çš„è¿™ä¸ªè¡¨å°±æ˜¯é¡µè¡¨ã€‚\næ’ç­‰æ˜ å°„ï¼š æ’ç­‰æ˜ å°„å³è™šæ‹Ÿåœ°å€=ç‰©ç†åœ°å€\nå…ˆä»æ’ç­‰æ˜ å°„å¼€å§‹æ˜¯å› ä¸ºï¼š\nä» BootLoader/BIOS è·³è½¬åˆ°æ“ä½œç³»ç»Ÿ(å¦‚ Linux å†…æ ¸)å…¥å£æ—¶,MMU æ˜¯å…³é—­çš„ã€‚å…³é—­äº†MMU æ„å‘³ç€ä¸èƒ½åˆ©ç”¨é«˜é€Ÿç¼“å­˜çš„æ€§èƒ½ã€‚ MMU å…³é—­: æ‰€æœ‰å†…å­˜è®¿é—®éƒ½æ˜¯ Non-cacheable,æ¯æ¬¡è®¿é—®ä¸»å­˜ ~100+ cyclesã€‚ MMU å¼€å¯: é¡µè¡¨æ ‡è®°å†…å­˜ä¸º Cacheable,Cache å‘½ä¸­ ~3-5 cyclesã€‚ å› æ­¤,æˆ‘ä»¬åœ¨åˆå§‹åŒ–çš„æŸä¸ªé˜¶æ®µéœ€è¦æŠŠ MMU æ‰“å¼€å¹¶ä¸”ä½¿èƒ½æ•°æ®é«˜é€Ÿç¼“å­˜,ä»¥è·å¾—æ›´é«˜çš„æ€§èƒ½ã€‚\nä½†æ˜¯MMUå¼€å¯çš„ç¬é—´ï¼ŒCPUå‘é€çš„æ‰€æœ‰æŒ‡ä»¤éƒ½ä¼šè¢«ç¿»è¯‘ã€‚å¦‚æœVAâ‰ PAï¼ŒPCæŒ‡å‘çš„åœ°å€ä¼šæŒ‡å‘é”™è¯¯ä½ç½®ã€‚è¿™æ—¶å€™æ’ç­‰æ˜ å°„å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œç¡®ä¿å¼€å¯å‰åä»£ç èƒ½æ­£å¸¸è¿è¡Œ\né¡µè¡¨ å‡è®¾æœ‰ä¸€ä¸ªuint64_t table[512],é€šè¿‡indexï¼Œæ•°ç»„è¿”å›ä¸€ä¸ªå€¼ã€‚é¡µè¡¨åŸç†ç±»ä¼¼ï¼ŒMMUæ‹¿åˆ°ä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼Œä»é‡Œé¢æ‰¾åˆ°å‡ ä¸ªbitå½“ä½œindexï¼Œä»é¡µè¡¨å»æŸ¥æ•°ç»„ï¼Œå¾—åˆ°ç»“æœã€‚å¦‚æœä¸€çº§æ•°ç»„æ¥è¦†ç›–æ•´ä¸ª48-bitåœ°å€ç©ºé—´ï¼Œéœ€è¦2^48ï¼Œä¸ç°å®ã€‚\næ‰€ä»¥éœ€è¦ç”¨åˆ°å¤šçº§æ•°ç»„ã€‚4KB garanuleæ˜¯ä¸€ä¸ªå››ç»´æ•°ç»„æŸ¥æ‰¾ï¼š\ntable_L0[i0] -\u003e æŒ‡å‘table_L1 table_L1[i1] -\u003e æŒ‡å‘table_L2 table_L2[i2] -\u003e æŒ‡å‘table_L3 table_L3[i3] -\u003e æœ€ç»ˆçš„ç‰©ç†é¡µåœ°å€ ä¸ºä»€ä¹ˆæ˜¯ 48-bit \u0026 4çº§é¡µè¡¨ï¼Ÿ 1. åŸºç¡€é™åˆ¶\né¡µå¤§å° (Page Size): 4KB ($2^{12}$ Bytes)ã€‚ æŒ‡é’ˆå¤§å°: ARM64 æ˜¯ 64 ä½ç³»ç»Ÿï¼Œæ¯ä¸ªé¡µè¡¨é¡¹ (PTE) éœ€ 8 Bytes ($64 \\text{ bits}$)ã€‚ 2. å•çº§é¡µè¡¨å®¹é‡è®¡ç®— ç”±äºä¸€é¡µåªæœ‰ 4KBï¼Œæ‰€ä»¥ä¸€å¼ é¡µè¡¨èƒ½å®¹çº³çš„æ¡ç›®æ•°ä¸ºï¼š $$\\frac{4096 \\text{ Bytes}}{8 \\text{ Bytes}} = 512 \\text{ Entries} = 2^9$$ è¿™æ„å‘³ç€ï¼Œæ¯ä¸€çº§ç´¢å¼•éœ€è¦ 9 bits ($2^9=512$)ã€‚\n3. åœ°å€ä½å®½æ¨å¯¼ (4çº§é¡µè¡¨) $$\\underbrace{9}{\\text{L0}} + \\underbrace{9}{\\text{L1}} + \\underbrace{9}{\\text{L2}} + \\underbrace{9}{\\text{L3}} + \\underbrace{12}_{\\text{Offset}} = \\mathbf{48 \\text{ bits}}$$\n4. ä¸ºä»€ä¹ˆä¸æ˜¯ 3 çº§ï¼Ÿ\n3çº§é¡µè¡¨: $9+9+9+12 = 39 \\text{ bits}$ã€‚å¯»å€èŒƒå›´ $2^{39} = 512 \\text{ GB}$ ï¼ˆæ˜æ˜¾ä¸å¤Ÿç”¨ï¼‰ã€‚ 4çº§é¡µè¡¨: $48 \\text{ bits}$ã€‚å¯»å€èŒƒå›´ $2^{48} = 256 \\text{ TB}$ ã€‚ å®ç°1GB Block mapping è¿™ä¸ªæ˜¯çœ‹æœ€ä½çš„ä¸¤ä½ï¼š\nå½“bit[0]ç­‰äº0çš„æ—¶å€™ï¼ŒDescriptoræ˜¯Invalidã€‚ å½“bit[0]ä¸º1çš„æ—¶å€™ï¼Œbit[1]ä¸º0åˆ™blcokï¼ˆé™¤äº†lv3ï¼‰ï¼Œbit[1]ä¸º1çš„è¯å°±æŒ‡å‘Table(ä¸‹ä¸€çº§é¡µè¡¨)ã€‚ç”±äºæˆ‘ä»¬æš‚æ—¶å…ˆå®ç°1GBçš„ï¼Œæš‚æ—¶ä¸ç”¨ç®¡lv3.![](images/bit_field.png æˆ‘ä»¬ç›®å‰åœ¨è·‘EL1ï¼Œæ²¡æœ‰ç”¨æˆ·æ€ç¨‹åºï¼Œé€‰ AP = 00ï¼ˆPrivRead, PrivWriteï¼‰ã€‚\nAF: AFå³Acess flagã€‚\nAF ä½ç”¨äºå‘Šè¯‰è½¯ä»¶æˆ–ç¡¬ä»¶ï¼šè¿™ä¸ªé¡µé¢æœ€è¿‘æ˜¯å¦è¢«è®¿é—®è¿‡ã€‚\nAF = 0çš„æ—¶å€™è¡¨ç¤ºé¡µé¢å°šæœªè®¿é—®ã€‚AF = 1è¡¨ç¤ºé¡µé¢å·²ç»è¢«è®¿é—®ã€‚\nAFçš„æ¯”ç‰¹ä½æ˜¯[10]ã€‚\nSHï¼š SH ç”¨æ¥å‘Šè¯‰ç¡¬ä»¶ä¸€å—å†…å­˜çš„æ•°æ®ï¼Œéœ€è¦å’Œè°ä¿æŒä¸€è‡´ã€‚\nStage 1 Shareability attributesï¼š SH[1:0] æ™®é€šå†…å­˜ è¡¥å……è¯´æ˜ 00 Non-shareable ä¸å…±äº«ã€‚è¿™å—å†…å­˜è¢«è§†ä¸ºåªæœ‰å½“å‰ CPU æ ¸åœ¨ä½¿ç”¨ã€‚ç¡¬ä»¶ä¸ä¼šå»çª¥æ¢å…¶ä»–æ ¸çš„ Cacheï¼Œå…¶ä»–æ ¸ä¹Ÿçœ‹ä¸åˆ°ä½ çš„ Cacheã€‚ 01 Reserved 10 Outer Shareable å¤–éƒ¨å…±äº«ã€‚é€šå¸¸æŒ‡æ•°æ®éœ€è¦åœ¨ CPU ç°‡ï¼ˆClusterï¼‰ä¹‹å¤–ä¹Ÿä¿æŒä¸€è‡´ï¼ˆä¾‹å¦‚ä¸ GPUã€DMA ç­‰å¤–è®¾å…±äº«ï¼Œå–å†³äºç³»ç»Ÿäº’è”æ¶æ„ï¼‰ã€‚ 11 Inner Shareable å†…éƒ¨å…±äº«ã€‚è¿™æ˜¯ SMP ç³»ç»Ÿçš„æ ‡å‡†é…ç½®ã€‚è¡¨ç¤ºæ‰€æœ‰è¿è¡ŒåŒä¸€ä¸ª OS/Hypervisor çš„ CPU æ ¸éƒ½èƒ½çœ‹åˆ°ä¸€è‡´çš„æ•°æ®ã€‚ SHçš„æ¯”ç‰¹ä½æ˜¯[9:8]ã€‚\nAttrIndx: AttrIndx æ˜¯ä¸€ä¸ªæŸ¥è¡¨ç´¢å¼•\nMAIR_EL1 é‡Œæœ‰ 8 ä¸ªæ§½ä½ï¼ˆAttr0~Attr7ï¼‰ï¼Œæ¯ä¸ªæ§½ä½å®šä¹‰ä¸€ç§å†…å­˜ç±»å‹ã€‚descriptor é‡Œçš„ AttrIndx å‘Šè¯‰ CPUï¼šâ€œå»ç¬¬ N ä¸ªæ§½ä½æŸ¥è¿™å—å†…å­˜è¯¥æ€ä¹ˆå¯¹å¾…ã€‚â€\næˆ‘ä»¬ç›®å‰éœ€è¦å®šä¹‰ä¸¤ä¸ªæ§½ä½ï¼Œä¸€ä¸ªç»™ Deviceï¼Œä¸€ä¸ªç»™ Normal memoryã€‚ç„¶åä¸åŒçš„ block descriptor ç”¨ä¸åŒçš„ AttrIndx å€¼æŒ‡è¿‡å»ã€‚\næˆ‘ä»¬ç›®å‰æ˜¯4KB granule + Level 1 Block descriptorï¼Œæ‰€ä»¥åªçœ‹è¿™è¡Œï¼š\nBlock[47:17] â†’ OAB[47:30] â†’ 4KB granule, level 1 Block descriptor. Descriptor bits [29:17] are RES0.\n[!NOTE] ç”±äº Hypervisorï¼ˆEL2ï¼‰é€šå¸¸åªè¿è¡Œå®ƒè‡ªå·±ï¼Œä¸æ¶‰åŠâ€œå­ç”¨æˆ·æ€â€ï¼ˆé™¤éå¼€å¯äº†ç‰¹å®šçš„è™šæ‹ŸåŒ–ç‰¹æ€§ï¼‰ï¼Œæ‰€ä»¥ AP[1] åœ¨è¿™é‡Œè¢«å¿½ç•¥äº†ï¼Œåªå‰© AP[2] èµ·ä½œç”¨ã€‚ For a stage 1 translation that supports one Exception level, AP[1] is RES1.\nAPä½¿ç”¨ä¸¤ä¸ªbitï¼ˆBits7:6ï¼‰.å¯¹åº”äº†å››ç§æƒé™çŠ¶æ€ï¼š\nAP[2:1] EL1æƒé™ EL0æƒé™ 00 READ/WRITE None 01 READ/WRITE READ/WRITE 10 READ None 11 READ READ å¯ä»¥çœ‹å‡ºï¼ŒAP[2]å¯¹åº”EL1æƒé™ï¼ŒAP[1]å¯¹åº”EL0æƒé™ã€‚ ç°é˜¶æ®µæˆ‘ä»¬çš„EL1æƒé™ç»™READ/WRITEã€‚\nMAIR_EL1ï¼š MAIR_EL1 æ˜¯ 64 ä½å¯„å­˜å™¨ï¼Œåˆ†æˆ 8 ä¸ª 8-bit æ§½ä½ï¼ˆAttr0 ~ Attr7ï¼‰ã€‚ 0b0000dd00 Device memory. See encoding of â€˜ddâ€™ for the type of Device memory\ndevice memory,ddå†³å®šå­ç±»å‹ã€‚\noooo é«˜2ä½å†³å®šçš„æ˜¯memoryçš„cacheç­–ç•¥ç±»å‹ï¼Œä½2ä½å†³å®šçš„æ˜¯allocateç­–ç•¥ã€‚\næˆ‘ä»¬éœ€è¦Write-Back Non-transient, Read-Allocate, Write-Allocate\né«˜2ä½ = 0b11 (Normal memory, Outer Write-Back Non-transient.) R = 1, W = 1 ï¼ˆR/W missæ—¶åˆ†é…cache lineï¼‰ iiii é«˜2ä½å†³å®šçš„æ˜¯memoryçš„cacheç­–ç•¥ç±»å‹ï¼Œä½2ä½å†³å®šçš„æ˜¯allocateç­–ç•¥ã€‚\næˆ‘ä»¬éœ€è¦Write-Back Non-transient, Read-Allocate, Write-Allocate\né«˜2ä½ = 0b11 (Normal memory, Inner Write-Back Non-transient) R = 1, W = 1 ï¼ˆR/W missæ—¶åˆ†é…cache lineï¼‰ 0xooooiiii = 0b1111_1111 = 0xFF\nTCR_EL1: The control register for stage 1 of the EL1\u00260 translation regime. ç”¨äº EL1 å’Œ EL0 åœ°å€è½¬æ¢æœºåˆ¶ä¸­ï¼Œç¬¬ä¸€é˜¶æ®µï¼ˆStage 1ï¼‰è½¬æ¢çš„æ§åˆ¶å¯„å­˜å™¨ã€‚\nTOSZ: TTBR0_EL1æ‰€å¼•ç”¨çš„å†…å­˜åŒºåŸŸçš„å¤§å°åç§»é‡ã€‚è¯¥åŒºåŸŸå¤§å°ä¸º2(64-T0SZ)å­—èŠ‚ã€‚\næˆ‘ä»¬éœ€è¦48-bitçš„è™šæ‹Ÿåœ°å€ç©ºé—´,ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„TCR_EL1.T0SZä¸º16ã€‚\nTG0: æˆ‘ä»¬æ˜¯4KBï¼ŒTG0ä¸º0b00ã€‚\nSH0: å¤šæ ¸åœºæ™¯ç”¨Inner Shareable,0b11ã€‚\nORGN0/IRGN0: è¿™ä¸¤ä¸ªå­—éƒ½æ˜¯CPUåšé¡µè¡¨walkæ—¶è®¿é—®é¡µè¡¨å†…å­˜é‡‡ç”¨çš„cacheç­–ç•¥ã€‚ å› ä¸ºé¡µè¡¨åœ¨æ™®é€šRAMé‡Œï¼Œæ‰€ä»¥é¡µè¡¨workåº”å½“æ˜¯cachableçš„ã€‚\nä¸¤è€…éƒ½é€‰æ‹©0b01ã€‚\næ€»ç»“TCR_EL1: TG0 = 0b00 [15:14] SH0 = 0b11 [13:12] ORGN0 = 0b01 [11:10] IRGN0 = 0b01 [9:8] TOSZ = 16 [5:0] å¼€å¯MMUæ­¥éª¤ 1.é…ç½®MAIR_EL1 ï¼šå®šä¹‰å†…å­˜å±æ€§æ§½ä½ 2.é…ç½®TCR_EL1ï¼šé«˜é€ŸCPUé¡µè¡¨æ ¼å¼ï¼Œå¦‚granuleã€åœ°å€å®½åº¦ 3.å†™å…¥TTBR0_EL1:æŠŠLevel 0é¡µè¡¨çš„ç‰©ç†åœ°å€å‘Šè¯‰CPU 4.SCTLR_EL1.M=1ï¼šå¼€å¯MMU\nmmu.h\n#ifndef __MMU_H__ #define __MMU_H__ /* MAIR_EL1 */ #define MAIR_DEVICE_nGnRnE (0x00 \u003c\u003c 0) #define MAIR_NORMAL_WB (0xFF \u003c\u003c 8) #define MAIR_EL1_VALUE (MAIR_NORMAL_WB | \\ MAIR_DEVICE_nGnRnE) /* TCR_EL1 */ #define TCR_T0SZ (16UL \u003c\u003c 0) #define TCR_IRGN0 (0x01UL \u003c\u003c 8) #define TCR_ORGN0 (0x01UL \u003c\u003c 10) #define TCR_SH0 (0x03UL \u003c\u003c 12) #define TCR_TG0 (0x00UL \u003c\u003c 14) #define TCR_EL1_VALUE (TCR_T0SZ | \\ TCR_IRGN0 | \\ TCR_ORGN0 | \\ TCR_SH0 | \\ TCR_TG0) /* descriptor */ #define DESC_AP (0x00UL \u003c\u003c 6) #define DESC_AF (0X01UL \u003c\u003c 10) #define DESC_SH_INNER (0X03UL \u003c\u003c 8) #define DESC_SH_OUTER (0X02UL \u003c\u003c 8) #define DESC_ATTRINDX_DEVICE (0x00UL \u003c\u003c 2) #define DESC_ATTRINDX_NORMAL (0x01UL \u003c\u003c 2) #define DESC_BLOCK (0x01UL) #define DESC_TABLE (0x03UL) #endif mmu.c\n#include \"mmu.h\" __attribute__((aligned(4096))) uint64_t l0_table[512]; __attribute__((aligned(4096))) uint64_t l1_table[512]; void mmu_init(void) { // L1[0]: 0x00000000 ~ 0x3FFFFFFF, Device l1_table[0] = 0x00000000UL | DESC_AF | DESC_SH_OUTER | DESC_ATTRINDX_DEVICE | DESC_BLOCK; // L1[0]: 0x40000000 ~ 0x7FFFFFFF, Normal l1_table[1] = 0x40000000UL | DESC_AF | DESC_SH_INNER | DESC_ATTRINDX_NORMAL | DESC_BLOCK; // L0[0]: table descriptor, point to next level table(L1) l0_table[0] = (uint64_t)l1_table | DESC_TABLE; } ","wordCount":"601","inLanguage":"en","datePublished":"2026-02-03T00:00:00Z","dateModified":"2026-02-03T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://human-mean.github.io/posts/arm64-hypervisor%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/4.%E6%81%92%E7%AD%89%E6%98%A0%E5%B0%84mmu/"},"publisher":{"@type":"Organization","name":"åµŒå…¥å¼å­¦ä¹ ç¬”è®°","logo":{"@type":"ImageObject","url":"https://human-mean.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://human-mean.github.io/ accesskey=h title="åµŒå…¥å¼å­¦ä¹ ç¬”è®° (Alt + H)">åµŒå…¥å¼å­¦ä¹ ç¬”è®°</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><div class=post-wrapper><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">4.æ’ç­‰æ˜ å°„MMU</h1><div class=post-meta><span title='2026-02-03 00:00:00 +0000 UTC'>February 3, 2026</span>&nbsp;Â·&nbsp;<span>3 min</span></div></header><div class=post-content><blockquote><p><strong>ğŸ“‹ ä¸€äº›åŸºç¡€æ¦‚å¿µ</strong></p><ul><li><p><strong>Stage 1</strong>:å°†<strong>è™šæ‹Ÿåœ°å€ (VA)</strong> è½¬æ¢ä¸º<strong>ç‰©ç†åœ°å€ (PA)</strong>ï¼ˆåœ¨éè™šæ‹ŸåŒ–ç¯å¢ƒä¸‹ï¼‰æˆ–è€…è½¬æ¢ä¸º<strong>ä¸­é—´ç‰©ç†åœ°å€ (IPA)</strong>ï¼ˆåœ¨è™šæ‹ŸåŒ–ç¯å¢ƒä¸‹ï¼‰ã€‚å®ƒä¸»è¦å— OS æ§åˆ¶ï¼Œç”¨æ¥åšè¿›ç¨‹éš”ç¦»ã€‚</p></li><li><p><strong>Stage 2</strong>ï¼šå°† <strong>IPA</strong> è½¬æ¢ä¸ºçœŸæ­£çš„ <strong>ç‰©ç†åœ°å€ (PA)</strong>ã€‚</p></li></ul></blockquote><h3 id=ä¸ºä»€ä¹ˆéœ€è¦mmu>ä¸ºä»€ä¹ˆéœ€è¦<strong>MMU</strong>ï¼Ÿ<a hidden class=anchor aria-hidden=true href=#ä¸ºä»€ä¹ˆéœ€è¦mmu>#</a></h3><p>è£¸æœºä»£ç ä¸­CPUå‘é€çš„åœ°å€ç›´æ¥å‘é€åˆ°ç‰©ç†å†…å­˜ã€‚ä½†å­˜åœ¨å‡ ä¸ªé—®é¢˜ï¼š</p><ul><li>æ‰€æœ‰ä»£ç éƒ½èƒ½è®¿é—®æ‰€æœ‰åœ°å€ï¼Œæ²¡æœ‰ä¿æŠ¤</li><li>è‹¥è·‘å¤šä¸ªGuest OS,åœ°å€ä¼šå­˜åœ¨å†²çª</li><li>æ²¡æ³•æ§åˆ¶æŸæ®µå†…å­˜æ˜¯ cacheable è¿˜æ˜¯ device ç±»å‹</li></ul><p>MMUå°±æ˜¯åœ¨CPUå’Œç‰©ç†å†…å­˜ä¸­å……å½“äº†ç¿»è¯‘ï¼šCPUå‘é€è™šæ‹Ÿåœ°å€ï¼ˆVAï¼‰ï¼ŒMMUé€šè¿‡æŸ¥è¡¨ç¿»è¯‘æˆç‰©ç†åœ°å€ï¼ˆPAï¼‰ï¼ŒåŒæ—¶é™„å¸¦æƒé™å’Œå±æ€§çš„ä¿¡æ¯ã€‚MMUæŸ¥çš„è¿™ä¸ªè¡¨å°±æ˜¯<strong>é¡µè¡¨</strong>ã€‚</p><h4 id=æ’ç­‰æ˜ å°„><strong>æ’ç­‰æ˜ å°„</strong>ï¼š<a hidden class=anchor aria-hidden=true href=#æ’ç­‰æ˜ å°„>#</a></h4><blockquote><p>æ’ç­‰æ˜ å°„å³è™šæ‹Ÿåœ°å€=ç‰©ç†åœ°å€</p></blockquote><p>å…ˆä»æ’ç­‰æ˜ å°„å¼€å§‹æ˜¯å› ä¸ºï¼š</p><blockquote><p>ä» BootLoader/BIOS è·³è½¬åˆ°æ“ä½œç³»ç»Ÿ(å¦‚ Linux å†…æ ¸)å…¥å£æ—¶,MMU æ˜¯å…³é—­çš„ã€‚å…³é—­äº†MMU æ„å‘³ç€ä¸èƒ½åˆ©ç”¨é«˜é€Ÿç¼“å­˜çš„æ€§èƒ½ã€‚
<strong>MMU å…³é—­</strong>: æ‰€æœ‰å†…å­˜è®¿é—®éƒ½æ˜¯ Non-cacheable,æ¯æ¬¡è®¿é—®ä¸»å­˜ ~100+ cyclesã€‚
<strong>MMU å¼€å¯</strong>: é¡µè¡¨æ ‡è®°å†…å­˜ä¸º Cacheable,Cache å‘½ä¸­ ~3-5 cyclesã€‚
å› æ­¤,æˆ‘ä»¬åœ¨åˆå§‹åŒ–çš„æŸä¸ªé˜¶æ®µéœ€è¦æŠŠ MMU æ‰“å¼€å¹¶ä¸”ä½¿èƒ½æ•°æ®é«˜é€Ÿç¼“å­˜,ä»¥è·å¾—æ›´é«˜çš„æ€§èƒ½ã€‚</p></blockquote><p><em><strong>ä½†æ˜¯MMUå¼€å¯çš„ç¬é—´ï¼ŒCPUå‘é€çš„æ‰€æœ‰æŒ‡ä»¤éƒ½ä¼šè¢«ç¿»è¯‘ã€‚å¦‚æœVAâ‰ PAï¼ŒPCæŒ‡å‘çš„åœ°å€ä¼šæŒ‡å‘é”™è¯¯ä½ç½®ã€‚è¿™æ—¶å€™æ’ç­‰æ˜ å°„å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œç¡®ä¿å¼€å¯å‰åä»£ç èƒ½æ­£å¸¸è¿è¡Œ</strong></em></p><h4 id=é¡µè¡¨>é¡µè¡¨<a hidden class=anchor aria-hidden=true href=#é¡µè¡¨>#</a></h4><p>å‡è®¾æœ‰ä¸€ä¸ª<code>uint64_t table[512]</code>,é€šè¿‡indexï¼Œæ•°ç»„è¿”å›ä¸€ä¸ªå€¼ã€‚é¡µè¡¨åŸç†ç±»ä¼¼ï¼ŒMMUæ‹¿åˆ°ä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼Œä»é‡Œé¢æ‰¾åˆ°å‡ ä¸ªbitå½“ä½œindexï¼Œä»é¡µè¡¨å»æŸ¥æ•°ç»„ï¼Œå¾—åˆ°ç»“æœã€‚å¦‚æœä¸€çº§æ•°ç»„æ¥è¦†ç›–æ•´ä¸ª48-bitåœ°å€ç©ºé—´ï¼Œéœ€è¦2^48ï¼Œä¸ç°å®ã€‚</p><p>æ‰€ä»¥éœ€è¦ç”¨åˆ°<strong>å¤šçº§æ•°ç»„</strong>ã€‚4KB garanuleæ˜¯ä¸€ä¸ªå››ç»´æ•°ç»„æŸ¥æ‰¾ï¼š</p><ul><li>table_L0[i0] -> æŒ‡å‘table_L1</li><li>table_L1[i1] -> æŒ‡å‘table_L2</li><li>table_L2[i2] -> æŒ‡å‘table_L3</li><li>table_L3[i3] -> æœ€ç»ˆçš„ç‰©ç†é¡µåœ°å€</li></ul><details open style="border:1px solid #448aff;border-left:4px solid #448aff;background-color:#f8f9fa;border-radius:4px;margin:1.5em 0;padding:0;overflow:hidden"><summary style="background-color:#448aff1a;padding:8px 12px;font-weight:700;cursor:pointer;color:#448aff;outline:none">ä¸ºä»€ä¹ˆæ˜¯ 48-bit & 4çº§é¡µè¡¨ï¼Ÿ</summary><div style=padding:15px;background:#fff;color:#333><p><strong>1. åŸºç¡€é™åˆ¶</strong></p><ul><li><strong>é¡µå¤§å° (Page Size):</strong> 4KB ($2^{12}$ Bytes)ã€‚</li><li><strong>æŒ‡é’ˆå¤§å°:</strong> ARM64 æ˜¯ 64 ä½ç³»ç»Ÿï¼Œæ¯ä¸ªé¡µè¡¨é¡¹ (PTE) éœ€ 8 Bytes ($64 \text{ bits}$)ã€‚</li></ul><p><strong>2. å•çº§é¡µè¡¨å®¹é‡è®¡ç®—</strong>
ç”±äºä¸€é¡µåªæœ‰ 4KBï¼Œæ‰€ä»¥ä¸€å¼ é¡µè¡¨èƒ½å®¹çº³çš„æ¡ç›®æ•°ä¸ºï¼š
$$\frac{4096 \text{ Bytes}}{8 \text{ Bytes}} = 512 \text{ Entries} = 2^9$$
è¿™æ„å‘³ç€ï¼Œæ¯ä¸€çº§ç´¢å¼•éœ€è¦ <strong>9 bits</strong> ($2^9=512$)ã€‚</p><p><strong>3. åœ°å€ä½å®½æ¨å¯¼ (4çº§é¡µè¡¨)</strong>
$$\underbrace{9}<em>{\text{L0}} + \underbrace{9}</em>{\text{L1}} + \underbrace{9}<em>{\text{L2}} + \underbrace{9}</em>{\text{L3}} + \underbrace{12}_{\text{Offset}} = \mathbf{48 \text{ bits}}$$</p><p><strong>4. ä¸ºä»€ä¹ˆä¸æ˜¯ 3 çº§ï¼Ÿ</strong></p><ul><li><strong>3çº§é¡µè¡¨:</strong> $9+9+9+12 = 39 \text{ bits}$ã€‚å¯»å€èŒƒå›´ $2^{39} = 512 \text{ GB}$ ï¼ˆæ˜æ˜¾ä¸å¤Ÿç”¨ï¼‰ã€‚</li><li><strong>4çº§é¡µè¡¨:</strong> $48 \text{ bits}$ã€‚å¯»å€èŒƒå›´ $2^{48} = 256 \text{ TB}$ ã€‚</li></ul></div></details><h3 id=å®ç°1gb-block-mapping>å®ç°1GB Block mapping<a hidden class=anchor aria-hidden=true href=#å®ç°1gb-block-mapping>#</a></h3><p><img src=/posts/ARM64%20Hypervisor%e5%ad%a6%e4%b9%a0%e8%ae%b0%e5%bd%95/images/Block_descriptor.png alt loading=lazy>
è¿™ä¸ªæ˜¯çœ‹æœ€ä½çš„ä¸¤ä½ï¼š</p><ul><li>å½“bit[0]ç­‰äº0çš„æ—¶å€™ï¼ŒDescriptoræ˜¯Invalidã€‚</li><li>å½“bit[0]ä¸º1çš„æ—¶å€™ï¼Œbit[1]ä¸º0åˆ™blcokï¼ˆé™¤äº†lv3ï¼‰ï¼Œbit[1]ä¸º1çš„è¯å°±æŒ‡å‘Table(ä¸‹ä¸€çº§é¡µè¡¨)ã€‚ç”±äºæˆ‘ä»¬æš‚æ—¶å…ˆå®ç°1GBçš„ï¼Œæš‚æ—¶ä¸ç”¨ç®¡lv3.![](images/bit_field.png</li></ul><p><img src=/posts/ARM64%20Hypervisor%e5%ad%a6%e4%b9%a0%e8%ae%b0%e5%bd%95/images/AP.png alt loading=lazy>
<img src=/posts/ARM64%20Hypervisor%e5%ad%a6%e4%b9%a0%e8%ae%b0%e5%bd%95/images/AP21%7d.png alt loading=lazy>
æˆ‘ä»¬ç›®å‰åœ¨è·‘EL1ï¼Œæ²¡æœ‰ç”¨æˆ·æ€ç¨‹åºï¼Œé€‰ <strong>AP = 00</strong>ï¼ˆPrivRead, PrivWriteï¼‰ã€‚</p><h4 id=af><strong>AF</strong>:<a hidden class=anchor aria-hidden=true href=#af>#</a></h4><p>AFå³Acess flagã€‚</p><p><strong>AF ä½ç”¨äºå‘Šè¯‰è½¯ä»¶æˆ–ç¡¬ä»¶ï¼šè¿™ä¸ªé¡µé¢æœ€è¿‘æ˜¯å¦è¢«è®¿é—®è¿‡ã€‚</strong></p><p><code>AF = 0</code>çš„æ—¶å€™è¡¨ç¤ºé¡µé¢å°šæœªè®¿é—®ã€‚<code>AF = 1</code>è¡¨ç¤ºé¡µé¢å·²ç»è¢«è®¿é—®ã€‚</p><p><img src=/posts/ARM64%20Hypervisor%e5%ad%a6%e4%b9%a0%e8%ae%b0%e5%bd%95/images/AF.png alt loading=lazy></p><p>AFçš„æ¯”ç‰¹ä½æ˜¯[10]ã€‚</p><h4 id=sh><strong>SH</strong>ï¼š<a hidden class=anchor aria-hidden=true href=#sh>#</a></h4><p><strong>SH ç”¨æ¥å‘Šè¯‰ç¡¬ä»¶ä¸€å—å†…å­˜çš„æ•°æ®ï¼Œéœ€è¦å’Œè°ä¿æŒä¸€è‡´ã€‚</strong></p><h6 id=stage-1-shareability-attributes><em>Stage 1 Shareability attributesï¼š</em><a hidden class=anchor aria-hidden=true href=#stage-1-shareability-attributes>#</a></h6><table><thead><tr><th>SH[1:0]</th><th>æ™®é€šå†…å­˜</th><th>è¡¥å……è¯´æ˜</th></tr></thead><tbody><tr><td>00</td><td>Non-shareable</td><td><strong>ä¸å…±äº«</strong>ã€‚è¿™å—å†…å­˜è¢«è§†ä¸ºåªæœ‰å½“å‰ CPU æ ¸åœ¨ä½¿ç”¨ã€‚ç¡¬ä»¶<strong>ä¸ä¼š</strong>å»çª¥æ¢å…¶ä»–æ ¸çš„ Cacheï¼Œå…¶ä»–æ ¸ä¹Ÿçœ‹ä¸åˆ°ä½ çš„ Cacheã€‚</td></tr><tr><td>01</td><td>Reserved</td><td></td></tr><tr><td>10</td><td>Outer Shareable</td><td><strong>å¤–éƒ¨å…±äº«</strong>ã€‚é€šå¸¸æŒ‡æ•°æ®éœ€è¦åœ¨ CPU ç°‡ï¼ˆClusterï¼‰ä¹‹å¤–ä¹Ÿä¿æŒä¸€è‡´ï¼ˆä¾‹å¦‚ä¸ GPUã€DMA ç­‰å¤–è®¾å…±äº«ï¼Œå–å†³äºç³»ç»Ÿäº’è”æ¶æ„ï¼‰ã€‚</td></tr><tr><td>11</td><td>Inner Shareable</td><td><strong>å†…éƒ¨å…±äº«</strong>ã€‚<strong>è¿™æ˜¯ SMP ç³»ç»Ÿçš„æ ‡å‡†é…ç½®</strong>ã€‚è¡¨ç¤ºæ‰€æœ‰è¿è¡ŒåŒä¸€ä¸ª OS/Hypervisor çš„ CPU æ ¸éƒ½èƒ½çœ‹åˆ°ä¸€è‡´çš„æ•°æ®ã€‚</td></tr></tbody></table><p>SHçš„æ¯”ç‰¹ä½æ˜¯[9:8]ã€‚</p><h3 id=attrindx><strong>AttrIndx</strong>:<a hidden class=anchor aria-hidden=true href=#attrindx>#</a></h3><p><strong>AttrIndx æ˜¯ä¸€ä¸ªæŸ¥è¡¨ç´¢å¼•</strong></p><p>MAIR_EL1 é‡Œæœ‰ 8 ä¸ªæ§½ä½ï¼ˆAttr0~Attr7ï¼‰ï¼Œæ¯ä¸ªæ§½ä½å®šä¹‰ä¸€ç§å†…å­˜ç±»å‹ã€‚descriptor é‡Œçš„ AttrIndx å‘Šè¯‰ CPUï¼š&ldquo;å»ç¬¬ N ä¸ªæ§½ä½æŸ¥è¿™å—å†…å­˜è¯¥æ€ä¹ˆå¯¹å¾…ã€‚&rdquo;</p><p>æˆ‘ä»¬ç›®å‰éœ€è¦å®šä¹‰ä¸¤ä¸ªæ§½ä½ï¼Œä¸€ä¸ªç»™ Deviceï¼Œä¸€ä¸ªç»™ Normal memoryã€‚ç„¶åä¸åŒçš„ block descriptor ç”¨ä¸åŒçš„ AttrIndx å€¼æŒ‡è¿‡å»ã€‚</p><p><img src=/posts/ARM64%20Hypervisor%e5%ad%a6%e4%b9%a0%e8%ae%b0%e5%bd%95/images/Output%20Address.png alt loading=lazy>
æˆ‘ä»¬ç›®å‰æ˜¯4KB granule + Level 1 Block descriptorï¼Œæ‰€ä»¥åªçœ‹è¿™è¡Œï¼š</p><blockquote><p><strong>Block[47:17]</strong> â†’ <strong>OAB[47:30]</strong> â†’ 4KB granule, level 1 Block descriptor. Descriptor bits [29:17] are RES0.</p></blockquote><blockquote><p>[!NOTE]
ç”±äº Hypervisorï¼ˆEL2ï¼‰é€šå¸¸åªè¿è¡Œå®ƒè‡ªå·±ï¼Œä¸æ¶‰åŠâ€œå­ç”¨æˆ·æ€â€ï¼ˆé™¤éå¼€å¯äº†ç‰¹å®šçš„è™šæ‹ŸåŒ–ç‰¹æ€§ï¼‰ï¼Œæ‰€ä»¥ <strong>AP[1] åœ¨è¿™é‡Œè¢«å¿½ç•¥äº†</strong>ï¼Œåªå‰© <code>AP[2]</code> èµ·ä½œç”¨ã€‚
For a stage 1 translation that supports one Exception level, AP[1] is RES1.</p></blockquote><p><img src=/posts/ARM64%20Hypervisor%e5%ad%a6%e4%b9%a0%e8%ae%b0%e5%bd%95/images/ap21.png alt loading=lazy>
<strong>AP</strong>ä½¿ç”¨ä¸¤ä¸ªbitï¼ˆBits7:6ï¼‰.å¯¹åº”äº†å››ç§æƒé™çŠ¶æ€ï¼š</p><table><thead><tr><th>AP[2:1]</th><th>EL1æƒé™</th><th>EL0æƒé™</th></tr></thead><tbody><tr><td>00</td><td>READ/WRITE</td><td>None</td></tr><tr><td>01</td><td>READ/WRITE</td><td>READ/WRITE</td></tr><tr><td>10</td><td>READ</td><td>None</td></tr><tr><td>11</td><td>READ</td><td>READ</td></tr><tr><td><strong>å¯ä»¥çœ‹å‡ºï¼ŒAP[2]å¯¹åº”EL1æƒé™ï¼ŒAP[1]å¯¹åº”EL0æƒé™ã€‚</strong></td><td></td><td></td></tr></tbody></table><p>ç°é˜¶æ®µæˆ‘ä»¬çš„EL1æƒé™ç»™READ/WRITEã€‚</p><h4 id=mair_><strong>MAIR_EL1</strong>ï¼š<a hidden class=anchor aria-hidden=true href=#mair_>#</a></h4><p>MAIR_EL1 æ˜¯ 64 ä½å¯„å­˜å™¨ï¼Œåˆ†æˆ 8 ä¸ª 8-bit æ§½ä½ï¼ˆAttr0 ~ Attr7ï¼‰ã€‚
<img src=/posts/ARM64%20Hypervisor%e5%ad%a6%e4%b9%a0%e8%ae%b0%e5%bd%95/images/MAIR_EL1.png alt loading=lazy></p><blockquote><p>0b0000dd00 Device memory. See encoding of â€˜ddâ€™ for the type of Device memory</p></blockquote><p>device memory,ddå†³å®šå­ç±»å‹ã€‚</p><h5 id=oooo><strong>oooo</strong><a hidden class=anchor aria-hidden=true href=#oooo>#</a></h5><p><img src=/posts/ARM64%20Hypervisor%e5%ad%a6%e4%b9%a0%e8%ae%b0%e5%bd%95/images/oooo.png alt loading=lazy>
<strong>é«˜2ä½</strong>å†³å®šçš„æ˜¯memoryçš„cacheç­–ç•¥ç±»å‹ï¼Œ<strong>ä½2ä½</strong>å†³å®šçš„æ˜¯allocateç­–ç•¥ã€‚</p><p>æˆ‘ä»¬éœ€è¦<code>Write-Back Non-transient, Read-Allocate, Write-Allocate</code></p><ul><li>é«˜2ä½ = 0b11 (Normal memory, Outer Write-Back Non-transient.)</li><li>R = 1, W = 1 ï¼ˆ<em>R/W missæ—¶åˆ†é…cache line</em>ï¼‰</li></ul><h5 id=iiii><strong>iiii</strong><a hidden class=anchor aria-hidden=true href=#iiii>#</a></h5><p><img src=/posts/ARM64%20Hypervisor%e5%ad%a6%e4%b9%a0%e8%ae%b0%e5%bd%95/images/iiii_encode.png alt loading=lazy>
<strong>é«˜2ä½</strong>å†³å®šçš„æ˜¯memoryçš„cacheç­–ç•¥ç±»å‹ï¼Œ<strong>ä½2ä½</strong>å†³å®šçš„æ˜¯allocateç­–ç•¥ã€‚</p><p>æˆ‘ä»¬éœ€è¦<code>Write-Back Non-transient, Read-Allocate, Write-Allocate</code></p><ul><li>é«˜2ä½ = 0b11 (<em>Normal memory, Inner Write-Back Non-transient</em>)</li><li>R = 1, W = 1 ï¼ˆ<em>R/W missæ—¶åˆ†é…cache line</em>ï¼‰</li><li><img src=/posts/ARM64%20Hypervisor%e5%ad%a6%e4%b9%a0%e8%ae%b0%e5%bd%95/images/RW.png alt loading=lazy></li></ul><hr><p>0xooooiiii = <code>0b1111_1111</code> = <code>0xFF</code></p><h4 id=tcr_><strong>TCR_EL1:</strong><a hidden class=anchor aria-hidden=true href=#tcr_>#</a></h4><blockquote><p>The control register for stage 1 of the EL1&amp;0 translation regime.
ç”¨äº EL1 å’Œ EL0 åœ°å€è½¬æ¢æœºåˆ¶ä¸­ï¼Œç¬¬ä¸€é˜¶æ®µï¼ˆStage 1ï¼‰è½¬æ¢çš„æ§åˆ¶å¯„å­˜å™¨ã€‚</p></blockquote><p><img src=/posts/ARM64%20Hypervisor%e5%ad%a6%e4%b9%a0%e8%ae%b0%e5%bd%95/images/Pasted%20image%2020260212001108.png alt loading=lazy></p><hr><p><img src=/posts/ARM64%20Hypervisor%e5%ad%a6%e4%b9%a0%e8%ae%b0%e5%bd%95/images/Pasted%20image%2020260212001728.png alt loading=lazy></p><h5 id=tosz><strong>TOSZ</strong>:<a hidden class=anchor aria-hidden=true href=#tosz>#</a></h5><p>TTBR0_EL1æ‰€å¼•ç”¨çš„å†…å­˜åŒºåŸŸçš„å¤§å°åç§»é‡ã€‚è¯¥åŒºåŸŸå¤§å°ä¸º2(64-T0SZ)å­—èŠ‚ã€‚</p><p>æˆ‘ä»¬éœ€è¦48-bitçš„è™šæ‹Ÿåœ°å€ç©ºé—´,ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„<code>TCR_EL1.T0SZ</code>ä¸º16ã€‚</p><h5 id=tg0><strong>TG0</strong>:<a hidden class=anchor aria-hidden=true href=#tg0>#</a></h5><p><img src=/posts/ARM64%20Hypervisor%e5%ad%a6%e4%b9%a0%e8%ae%b0%e5%bd%95/images/TG0.png alt loading=lazy>
æˆ‘ä»¬æ˜¯4KBï¼ŒTG0ä¸º0b00ã€‚</p><h5 id=sh0><strong>SH0:</strong><a hidden class=anchor aria-hidden=true href=#sh0>#</a></h5><p><img src=/posts/ARM64%20Hypervisor%e5%ad%a6%e4%b9%a0%e8%ae%b0%e5%bd%95/images/SH0.png alt loading=lazy>
å¤šæ ¸åœºæ™¯ç”¨<code>Inner Shareable</code>,0b11ã€‚</p><h5 id=orgn0irgn0><strong>ORGN0/IRGN0:</strong><a hidden class=anchor aria-hidden=true href=#orgn0irgn0>#</a></h5><p><img src=/posts/ARM64%20Hypervisor%e5%ad%a6%e4%b9%a0%e8%ae%b0%e5%bd%95/images/ORGN0IRGN0.png alt loading=lazy>
è¿™ä¸¤ä¸ªå­—éƒ½æ˜¯CPUåšé¡µè¡¨walkæ—¶è®¿é—®é¡µè¡¨å†…å­˜é‡‡ç”¨çš„<strong>cacheç­–ç•¥</strong>ã€‚
å› ä¸ºé¡µè¡¨åœ¨æ™®é€šRAMé‡Œï¼Œæ‰€ä»¥é¡µè¡¨workåº”å½“æ˜¯cachableçš„ã€‚</p><p>ä¸¤è€…éƒ½é€‰æ‹©<code>0b01</code>ã€‚</p><h5 id=æ€»ç»“tcr_el1>æ€»ç»“TCR_EL1:<a hidden class=anchor aria-hidden=true href=#æ€»ç»“tcr_el1>#</a></h5><ul><li>TG0 = 0b00 [15:14]</li><li>SH0 = 0b11 [13:12]</li><li>ORGN0 = 0b01 [11:10]</li><li>IRGN0 = 0b01 [9:8]</li><li>TOSZ = 16 [5:0]</li></ul><h3 id=å¼€å¯mmuæ­¥éª¤>å¼€å¯MMUæ­¥éª¤<a hidden class=anchor aria-hidden=true href=#å¼€å¯mmuæ­¥éª¤>#</a></h3><p>1.<strong>é…ç½®MAIR_EL1</strong> ï¼šå®šä¹‰å†…å­˜å±æ€§æ§½ä½
2.<strong>é…ç½®TCR_EL1</strong>ï¼šé«˜é€ŸCPUé¡µè¡¨æ ¼å¼ï¼Œå¦‚granuleã€åœ°å€å®½åº¦
3.<strong>å†™å…¥TTBR0_EL1</strong>:æŠŠLevel 0é¡µè¡¨çš„ç‰©ç†åœ°å€å‘Šè¯‰CPU
4.<code>SCTLR_EL1.M=1</code>ï¼šå¼€å¯MMU</p><p><strong>mmu.h</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#75715e>#ifndef __MMU_H__
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define __MMU_H__
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* MAIR_EL1 */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define MAIR_DEVICE_nGnRnE (0x00 &lt;&lt; 0)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define MAIR_NORMAL_WB     (0xFF &lt;&lt; 8)
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define MAIR_EL1_VALUE    (MAIR_NORMAL_WB | \
</span></span></span><span style=display:flex><span><span style=color:#75715e>                            MAIR_DEVICE_nGnRnE)
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* TCR_EL1 */</span>                            
</span></span><span style=display:flex><span><span style=color:#75715e>#define TCR_T0SZ           (16UL &lt;&lt; 0)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define TCR_IRGN0          (0x01UL &lt;&lt; 8)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define TCR_ORGN0          (0x01UL &lt;&lt; 10)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define TCR_SH0            (0x03UL &lt;&lt; 12)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define TCR_TG0            (0x00UL &lt;&lt; 14)
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define TCR_EL1_VALUE (TCR_T0SZ  | \
</span></span></span><span style=display:flex><span><span style=color:#75715e>                      TCR_IRGN0  | \
</span></span></span><span style=display:flex><span><span style=color:#75715e>                      TCR_ORGN0  | \
</span></span></span><span style=display:flex><span><span style=color:#75715e>                      TCR_SH0 | \
</span></span></span><span style=display:flex><span><span style=color:#75715e>                      TCR_TG0)
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* descriptor */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define DESC_AP                 (0x00UL &lt;&lt; 6)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define DESC_AF                 (0X01UL &lt;&lt; 10)     
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define DESC_SH_INNER           (0X03UL &lt;&lt; 8)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define DESC_SH_OUTER           (0X02UL &lt;&lt; 8)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define DESC_ATTRINDX_DEVICE    (0x00UL &lt;&lt; 2)  
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define DESC_ATTRINDX_NORMAL    (0x01UL &lt;&lt; 2)  
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define DESC_BLOCK              (0x01UL) 
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define DESC_TABLE              (0x03UL) 
</span></span></span><span style=display:flex><span>                        
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span></code></pre></div><p><strong>mmu.c</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;mmu.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>__attribute__</span>((<span style=color:#a6e22e>aligned</span>(<span style=color:#ae81ff>4096</span>))) <span style=color:#66d9ef>uint64_t</span> l0_table[<span style=color:#ae81ff>512</span>];
</span></span><span style=display:flex><span><span style=color:#a6e22e>__attribute__</span>((<span style=color:#a6e22e>aligned</span>(<span style=color:#ae81ff>4096</span>))) <span style=color:#66d9ef>uint64_t</span> l1_table[<span style=color:#ae81ff>512</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>mmu_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// L1[0]: 0x00000000 ~ 0x3FFFFFFF, Device
</span></span></span><span style=display:flex><span>    l1_table[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x00000000UL</span> <span style=color:#f92672>|</span> DESC_AF <span style=color:#f92672>|</span> DESC_SH_OUTER <span style=color:#f92672>|</span> DESC_ATTRINDX_DEVICE <span style=color:#f92672>|</span> DESC_BLOCK;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// L1[0]: 0x40000000 ~ 0x7FFFFFFF, Normal
</span></span></span><span style=display:flex><span>    l1_table[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x40000000UL</span> <span style=color:#f92672>|</span> DESC_AF <span style=color:#f92672>|</span> DESC_SH_INNER <span style=color:#f92672>|</span> DESC_ATTRINDX_NORMAL <span style=color:#f92672>|</span> DESC_BLOCK;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// L0[0]: table descriptor, point to next level table(L1)
</span></span></span><span style=display:flex><span>    l0_table[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> (<span style=color:#66d9ef>uint64_t</span>)l1_table <span style=color:#f92672>|</span> DESC_TABLE;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags></ul></footer></article><aside class=toc-sidebar><div class=toc-inner><details open><summary>ç›®å½•</summary><nav id=TableOfContents><ul><li><ul><li><a href=#ä¸ºä»€ä¹ˆéœ€è¦mmu>ä¸ºä»€ä¹ˆéœ€è¦<strong>MMU</strong>ï¼Ÿ</a><ul><li><a href=#æ’ç­‰æ˜ å°„><strong>æ’ç­‰æ˜ å°„</strong>ï¼š</a></li><li><a href=#é¡µè¡¨>é¡µè¡¨</a></li></ul></li><li><a href=#å®ç°1gb-block-mapping>å®ç°1GB Block mapping</a><ul><li><a href=#af><strong>AF</strong>:</a></li><li><a href=#sh><strong>SH</strong>ï¼š</a><ul><li></li></ul></li></ul></li><li><a href=#attrindx><strong>AttrIndx</strong>:</a><ul><li><a href=#mair_><strong>MAIR_EL1</strong>ï¼š</a><ul><li><a href=#oooo><strong>oooo</strong></a></li><li><a href=#iiii><strong>iiii</strong></a></li></ul></li><li><a href=#tcr_><strong>TCR_EL1:</strong></a><ul><li><a href=#tosz><strong>TOSZ</strong>:</a></li><li><a href=#tg0><strong>TG0</strong>:</a></li><li><a href=#sh0><strong>SH0:</strong></a></li><li><a href=#orgn0irgn0><strong>ORGN0/IRGN0:</strong></a></li><li><a href=#æ€»ç»“tcr_el1>æ€»ç»“TCR_EL1:</a></li></ul></li></ul></li><li><a href=#å¼€å¯mmuæ­¥éª¤>å¼€å¯MMUæ­¥éª¤</a></li></ul></li></ul></nav></details></div></aside></div></main><footer class=footer><span>&copy; 2026 <a href=https://human-mean.github.io/>åµŒå…¥å¼å­¦ä¹ ç¬”è®°</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>